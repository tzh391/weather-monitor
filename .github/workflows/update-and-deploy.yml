name: Collect Weather Data

on:
  schedule:
    # æ¯5åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
    - cron: '*/5 * * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'scripts/dataCollector.js'
      - 'scripts/generateWebPage.js'
      - '.github/workflows/collect-data.yml'

# è®¾ç½®æƒé™
permissions:
  contents: write  # å…è®¸å†™å…¥å’Œæ¨é€

jobs:
  collect:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: ğŸ“‚ Create directories
        run: |
          mkdir -p weather_data
          mkdir -p public
          ls -la
          echo "Current directory: $(pwd)"
          echo "Scripts directory exists: $(test -d scripts && echo 'yes' || echo 'no')"
          echo "weather_data exists: $(test -d weather_data && echo 'yes' || echo 'no')"
          echo "Files in scripts/:"
          ls -la scripts/ || echo "scripts directory not found"
      
      - name: ğŸŒ¤ï¸ Collect weather data
        run: |
          echo "=========================================="
          echo "Starting data collection..."
          echo "=========================================="
          node scripts/dataCollector.js
          echo "=========================================="
          echo "Data collection completed"
          echo "=========================================="
      
      - name: ğŸ“Š Check generated files
        run: |
          echo "=========================================="
          echo "Checking weather_data directory..."
          echo "=========================================="
          ls -lah weather_data/ || echo "weather_data directory is empty or doesn't exist"
          echo ""
          echo "File count:"
          find weather_data -name "*.csv" 2>/dev/null | wc -l
          echo ""
          echo "CSV files:"
          find weather_data -name "*.csv" -exec echo "  - {}" \; -exec wc -l {} \; 2>/dev/null || echo "No CSV files found"
          echo ""
          echo "Sample content (first 5 lines of first file):"
          find weather_data -name "*.csv" -type f 2>/dev/null | head -1 | xargs head -5 || echo "No CSV files found"
      
      - name: ğŸ“ˆ Generate web page
        run: |
          echo "=========================================="
          echo "Generating web page..."
          echo "=========================================="
          node scripts/generateWebPage.js
          echo "=========================================="
          echo "Web page generation completed"
          echo "=========================================="
      
      - name: ğŸ“Š Check output files
        run: |
          echo "=========================================="
          echo "Checking public directory..."
          echo "=========================================="
          ls -lah public/ || echo "public directory is empty or doesn't exist"
          echo ""
          if [ -f public/weather_data.json ]; then
            echo "weather_data.json size: $(wc -c < public/weather_data.json) bytes"
            echo "First 500 characters:"
            head -c 500 public/weather_data.json
          else
            echo "weather_data.json not found"
          fi
          echo ""
          if [ -f public/index.html ]; then
            echo "index.html size: $(wc -c < public/index.html) bytes"
          else
            echo "index.html not found"
          fi
      
      - name: ğŸ” Debug - Show all files
        if: always()
        run: |
          echo "=========================================="
          echo "All files in workspace:"
          echo "=========================================="
          find . -type f \( -name "*.csv" -o -name "*.json" -o -name "*.html" \) 2>/dev/null | head -30
          echo ""
          echo "Directory structure:"
          tree -L 2 -a || ls -R
      
      - name: ğŸ“¤ Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ·»åŠ æ‰€æœ‰æ•°æ®æ–‡ä»¶
          git add weather_data/*.csv 2>/dev/null || echo "No CSV files to add"
          git add public/weather_data.json 2>/dev/null || echo "No JSON file to add"
          git add public/index.html 2>/dev/null || echo "No HTML file to add"
          
          # æ˜¾ç¤ºå°†è¦æäº¤çš„æ–‡ä»¶
          echo "Files staged for commit:"
          git diff --staged --name-only
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            echo "Committing changes..."
            git commit -m "ğŸŒ¤ï¸ Update weather data - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            git push
            echo "Changes pushed successfully"
          fi
      
      - name: ğŸ“Š Upload artifacts (for debugging)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: weather-data-${{ github.run_number }}
          path: |
            weather_data/
            public/
            scripts/
          retention-days: 7
